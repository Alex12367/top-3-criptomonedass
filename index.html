// =======================================================
//   OBTENER DATOS DE COINGECKO (SIN API KEY)
// =======================================================
async function fetchCryptoData() {
    try {
        const url =
            "https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=bitcoin,ethereum,tether";

        const response = await fetch(url);

        if (!response.ok) throw new Error("HTTP " + response.status);

        const data = await response.json();
        renderCryptos(data);

        return data;

    } catch (error) {
        document.getElementById("error").textContent = "Error al cargar datos.";
        console.error(error);
        return null;
    }
}

// =======================================================
//   MOSTRAR CRIPTOMONEDAS
// =======================================================
function renderCryptos(cryptos) {
    const container = document.getElementById("cryptos");
    container.innerHTML = "";

    cryptos.forEach(c => {
        container.innerHTML += `
            <div class="card">
                <h2>${c.name} (${c.symbol.toUpperCase()})</h2>
                <p><strong>Precio:</strong> $${c.current_price.toLocaleString()}</p>
                <p><strong>24h:</strong> ${c.price_change_percentage_24h.toFixed(2)}%</p>
                <p><strong>Cap. mercado:</strong> $${c.market_cap.toLocaleString()}</p>
            </div>
        `;
    });
}

// =======================================================
//   HISTORIAL EN LOCALSTORAGE
// =======================================================
function saveSnapshot(data) {
    let history = JSON.parse(localStorage.getItem("history") || "[]");

    history.push({
        date: new Date().toLocaleString(),
        data: data
    });

    localStorage.setItem("history", JSON.stringify(history));
    renderHistory();
}

function renderHistory() {
    let history = JSON.parse(localStorage.getItem("history") || "[]");
    const container = document.getElementById("history");

    if (history.length === 0) {
        container.innerHTML = "<p>Sin datos aún.</p>";
        return;
    }

    container.innerHTML = history.map(h => `
        <div class="hist-item">
            <strong>${h.date}</strong>
            <pre>${JSON.stringify(h.data, null, 2)}</pre>
        </div>
    `).join("");
}

// =======================================================
//   ACTUALIZACIÓN AUTOMÁTICA (10s)
// =======================================================
setInterval(async () => {
    await fetchCryptoData();
}, 10000);

// =======================================================
//   GUARDAR HISTORIAL CADA 30 MINUTOS
// =======================================================
setInterval(async () => {
    const data = await fetchCryptoData();
    if (data) saveSnapshot(data);
}, 1800000); // 30m = 1800000ms

// Botón "Registrar ahora"
document.getElementById("saveNow").onclick = async () => {
    const data = await fetchCryptoData();
    if (data) saveSnapshot(data);
};

// Cargar historial + primera actualización
renderHistory();
fetchCryptoData();





