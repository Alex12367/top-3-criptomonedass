<script>
async function fetchCryptoData() {
    try {
        const url = "https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=bitcoin,ethereum,tether";

        const response = await fetch(url);

        if (!response.ok) throw new Error("HTTP " + response.status);

        const data = await response.json();
        renderCryptos(data);
        return data;

    } catch (error) {
        document.getElementById("error").textContent = "Error al cargar datos.";
        console.error(error);
        return null;
    }
}

function renderCryptos(cryptos) {
    const container = document.getElementById("cryptos");
    container.innerHTML = "";

    cryptos.forEach(c => {
        container.innerHTML += `
            <div class="card">
                <h2>${c.name} (${c.symbol.toUpperCase()})</h2>
                <p><strong>Precio:</strong> $${c.current_price}</p>
                <p><strong>24h:</strong> ${c.price_change_percentage_24h.toFixed(2)}%</p>
                <p><strong>Cap. mercado:</strong> $${c.market_cap}</p>
            </div>
        `;
    });
}

/* ---------- HISTORIAL ---------- */

function saveSnapshot(data) {
    let history = JSON.parse(localStorage.getItem("history") || "[]");
    history.push({
        date: new Date().toLocaleString(),
        data: data
    });
    localStorage.setItem("history", JSON.stringify(history));
    renderHistory();
}

function renderHistory() {
    let history = JSON.parse(localStorage.getItem("history") || "[]");
    const container = document.getElementById("history");
    container.innerHTML = history.length === 0
        ? "<p>Sin datos aún.</p>"
        : history.map(h => `
            <div class="hist-item">
                <strong>${h.date}</strong>
                <pre>${JSON.stringify(h.data, null, 2)}</pre>
            </div>
        `).join("");
}

/* --- ACTUALIZACIÓN AUTOMÁTICA --- */

setInterval(async () => {
    const data = await fetchCryptoData();
}, 10000); // actualizar cada 10s

/* --- GUARDADO AUTOMÁTICO CADA 30 min --- */

setInterval(async () => {
    const data = await fetchCryptoData();
    if (data) saveSnapshot(data);
}, 1800000);

/* --- BOTÓN REGISTRAR AHORA --- */

document.getElementById("saveNow").onclick = async () => {
    const data = await fetchCryptoData();
    if (data) saveSnapshot(data);
};

renderHistory();
fetchCryptoData();
</script>



